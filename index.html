<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sender — 5 MP3s + Themes + mp3Src metadata</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    /* (kept compact — same styles as before) */
    :root{--bg:#071025;--fg:#e6eef8;--card:#0f1724;--muted:#90a4b7;--primary:#2563eb}
    .theme-red{--primary:#ef4444}.theme-green{--primary:#10b981}.theme-pink{--primary:#db2777}.theme-black{--primary:#111827}.theme-disco{animation:disco-hue 6s linear infinite}
    @keyframes disco-hue{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#000);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{min-height:100%;display:grid;place-items:center;padding:20px}
    .card{width:100%;max-width:980px;background:linear-gradient(180deg,var(--card),#061025);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,.04);box-shadow:0 8px 28px rgba(0,0,0,.45)}
    .themes{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}.theme-btn{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.06);background:transparent;color:var(--fg);cursor:pointer}
    .input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);color:var(--fg);outline:none}
    textarea{min-height:100px;resize:vertical}.player{border-radius:12px;padding:10px;background:rgba(255,255,255,.01);border:1px dashed rgba(255,255,255,.03)}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}.btn-primary{background:var(--primary);color:white}.btn-ghost{background:rgba(255,255,255,.03)}
    .small{font-size:13px;color:var(--muted)}.status{margin-top:8px;font-size:13px;min-height:18px}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="root" class="card">
      <h1>Sender — 5 MP3s (now sends mp3Src for public URLs)</h1>
      <div class="small">When you Play a slot we send message `yoooooooooooooo`. If the audio source is a public HTTP(S) URL, we also attach <code>mp3Src</code> so receivers can play & disco.</div>

      <div class="themes">
        <button class="theme-btn" data-theme="none">Default</button>
        <button class="theme-btn" data-theme="theme-red">Red</button>
        <button class="theme-btn" data-theme="theme-green">Green</button>
        <button class="theme-btn" data-theme="theme-pink">Pink</button>
        <button class="theme-btn" data-theme="theme-black">Black</button>
        <button class="theme-btn" data-theme="theme-disco">Disco</button>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px;">
        <input id="name" class="input" placeholder="Your name (e.g., zezo)" />
        <label style="display:inline-flex;align-items:center;gap:8px;">
          <input id="verified" type="checkbox" />
          <span class="small">Verified (adds ✅)</span>
        </label>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
        <div>
          <h3>Message Controls</h3>
          <textarea id="messageManual" class="input" placeholder="Manual message"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="sendBtn" class="btn btn-primary">Send Manual</button>
            <button id="sendYooBtn" class="btn btn-ghost">Send yoooooooooooooo</button>
          </div>
          <div id="status" class="status small"></div>
        </div>

        <div>
          <h3>MP3 Slots (5)</h3>
          <div id="slots"></div>
        </div>
      </div>
    </div>
  </div>

  <template id="slot-tpl">
    <div class="player" style="margin-bottom:10px;">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <input class="input mp3-url" placeholder="MP3 URL (https://... .mp3)" />
        <input type="file" accept="audio/*" class="mp3-file" />
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-primary play-btn">Play ▶</button>
        <button class="btn btn-ghost load-btn">Load</button>
        <button class="btn btn-ghost stop-btn">Stop ⏹</button>
        <span class="small source-name" style="margin-left:8px;color:var(--muted)"></span>
      </div>
      <audio class="audio-el" playsinline controls style="width:100%;margin-top:8px;"></audio>
    </div>
  </template>

  <script>
    // Firebase config (your config)
    const firebaseConfig = {
      apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
      authDomain: "sharplabubu.firebaseapp.com",
      databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
      projectId: "sharplabubu",
      storageBucket: "sharplabubu.firebasestorage.app",
      messagingSenderId: "596148393481",
      appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
      measurementId: "G-4M25R3BF08"
    };
    const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db  = firebase.database();

    const statusEl = document.getElementById('status');
    function setStatus(t, ok=false){ statusEl.textContent = t || ''; statusEl.style.color = ok ? '#34d399' : '#f87171'; }

    // theme
    const root = document.getElementById('root');
    function applyTheme(cls){ root.classList.remove('theme-red','theme-green','theme-pink','theme-black','theme-disco'); if(cls && cls !== 'none') root.classList.add(cls); localStorage.setItem('sender-theme', cls||'none'); }
    applyTheme(localStorage.getItem('sender-theme')||'none');
    document.querySelectorAll('.theme-btn').forEach(b=>b.addEventListener('click', ()=>applyTheme(b.dataset.theme)));

    // create 5 slots
    const slotsContainer = document.getElementById('slots');
    const tpl = document.getElementById('slot-tpl');
    for(let i=0;i<5;i++){ slotsContainer.appendChild(tpl.content.cloneNode(true)); }

    // helper to send message and (optionally) mp3Src
    function sendMessage(name, text, verified=false, mp3Src=null){
      try{
        // Only send mp3Src if it's an https/http url (not blob:, data:, or empty)
        const payload = {
          name: String(name||'').trim() || 'anonymous',
          message: String(text||''),
          verified: !!verified,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        if(mp3Src && /^https?:\/\//i.test(mp3Src)) payload.mp3Src = mp3Src;
        db.ref('messages').push(payload);
        setStatus('Sent to Firebase', true);
      }catch(e){ console.error(e); setStatus('Failed to send (console).'); }
    }

    // manual buttons
    document.getElementById('sendBtn').addEventListener('click', ()=>{
      const name = document.getElementById('name').value.trim();
      const text = document.getElementById('messageManual').value.trim();
      const verified = document.getElementById('verified') && document.getElementById('verified').checked;
      if(!text){ setStatus('Type a message first'); return; }
      sendMessage(name, text, verified, null);
    });
    document.getElementById('sendYooBtn').addEventListener('click', ()=>{
      const name = document.getElementById('name').value.trim();
      const verified = document.getElementById('verified') && document.getElementById('verified').checked;
      sendMessage(name, 'yoooooooooooooo', verified, null);
    });

    // wire slots
    const players = Array.from(document.querySelectorAll('.player'));
    // but template nodes were appended after initial selection — reselect
    const createdPlayers = Array.from(document.querySelectorAll('.player'));
    createdPlayers.forEach(player => {
      const urlIn = player.querySelector('.mp3-url');
      const fileIn = player.querySelector('.mp3-file');
      const playBtn = player.querySelector('.play-btn');
      const loadBtn = player.querySelector('.load-btn');
      const stopBtn = player.querySelector('.stop-btn');
      const audioEl = player.querySelector('.audio-el');
      const srcLabel = player.querySelector('.source-name');

      loadBtn.addEventListener('click', ()=>{
        const url = urlIn.value.trim();
        if(!url){ setStatus('Enter MP3 URL first'); return; }
        audioEl.src = url;
        audioEl.load();
        srcLabel.textContent = 'URL loaded';
        setStatus('URL loaded. Tap Play ▶', true);
      });

      fileIn.addEventListener('change', ()=>{
        const f = fileIn.files && fileIn.files[0];
        if(!f) return;
        const blob = URL.createObjectURL(f);
        audioEl.src = blob;
        audioEl.load();
        srcLabel.textContent = f.name || 'local file';
        setStatus('Local file loaded. Note: local files do NOT play on remote receivers.', false);
      });

      // play — this is the user gesture. we will try to include mp3Src if it's http(s)
      playBtn.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        const name = document.getElementById('name').value.trim() || 'anonymous';
        const verified = document.getElementById('verified') && document.getElementById('verified').checked;

        // ensure a source
        if(!audioEl.src){
          if(urlIn.value.trim()){ audioEl.src = urlIn.value.trim(); audioEl.load(); srcLabel.textContent='URL loaded'; }
          else if(fileIn.files && fileIn.files[0]){ audioEl.src = URL.createObjectURL(fileIn.files[0]); audioEl.load(); srcLabel.textContent='local file'; }
          else { setStatus('No source — paste URL or choose file'); return; }
        }

        try{
          await audioEl.play(); // user gesture
          setStatus('Playing — sending yoooooooooooooo', true);
          // send message with mp3Src only if it's an http(s) URL (not blob:)
          const curSrc = audioEl.currentSrc || audioEl.src || '';
          const mp3Src = /^https?:\/\//i.test(curSrc) ? curSrc : null;
          sendMessage(name, 'yoooooooooooooo', verified, mp3Src);
        }catch(err){
          console.error('play failed', err);
          setStatus('Play failed — maybe format or gesture issue', false);
        }
      });

      stopBtn.addEventListener('click', ()=>{ if(!audioEl.paused) audioEl.pause(); audioEl.currentTime=0; setStatus('Stopped', true); });

      // also if user uses native controls to play, send once (avoid duplicates with small throttle)
      audioEl.addEventListener('play', ()=>{
        const last = player._lastAutoSend || 0;
        const now = Date.now();
        if(now - last > 1500){
          const name = document.getElementById('name').value.trim() || 'anonymous';
          const verified = document.getElementById('verified') && document.getElementById('verified').checked;
          const curSrc = audioEl.currentSrc || audioEl.src || '';
          const mp3Src = /^https?:\/\//i.test(curSrc) ? curSrc : null;
          sendMessage(name, 'yoooooooooooooo', verified, mp3Src);
          player._lastAutoSend = now;
          setStatus('Playing (control) — sent yoooooooooooooo', true);
        }
      });
    });

  </script>
</body>
</html>
